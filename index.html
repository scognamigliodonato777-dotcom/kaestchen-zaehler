<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KÃ¤stchen-ZÃ¤hler</title>
  <style>
    body { font-family: system-ui; padding: 16px; max-width: 720px; margin: auto; }
    button { padding: 10px 14px; font-size: 16px; }
    #out { background: #f4f4f4; padding: 12px; border-radius: 10px; white-space: pre-line; }
    canvas { max-width: 100%; margin-top: 10px; display: none; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
  </style>
</head>
<body>

<h2>KÃ¤stchen-ZÃ¤hler</h2>

<div class="row">
  <input id="photo" type="file" accept="image/*" capture="environment">
  <button onclick="run()">Auswerten</button>
</div>

<p id="out">Foto wÃ¤hlen â†’ Auswerten</p>
<canvas id="cv"></canvas>

<script>
const canvas = document.getElementById("cv");
const ctx = canvas.getContext("2d", { willReadFrequently: true });
const out = document.getElementById("out");

function rgbToHsv(r,g,b){
  r/=255; g/=255; b/=255;
  const max=Math.max(r,g,b), min=Math.min(r,g,b);
  const d=max-min;
  let h=0;
  if(d){
    if(max===r) h=((g-b)/d)%6;
    else if(max===g) h=(b-r)/d+2;
    else h=(r-g)/d+4;
    h*=60; if(h<0) h+=360;
  }
  const s = max ? d/max : 0;
  return [h, s*255, max*255];
}

function countSquares(mask, w, h){
  const visited = new Uint8Array(w*h);
  let count = 0;

  const idx=(x,y)=>y*w+x;

  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const i = idx(x,y);
      if(!mask[i] || visited[i]) continue;

      let area=0, minx=x, maxx=x, miny=y, maxy=y;
      const stack=[i];
      visited[i]=1;

      while(stack.length){
        const p = stack.pop();
        area++;
        const px=p%w, py=(p/w)|0;
        minx=Math.min(minx,px); maxx=Math.max(maxx,px);
        miny=Math.min(miny,py); maxy=Math.max(maxy,py);

        for(let ny=py-1;ny<=py+1;ny++){
          for(let nx=px-1;nx<=px+1;nx++){
            if(nx<0||ny<0||nx>=w||ny>=h) continue;
            const ni=idx(nx,ny);
            if(mask[ni] && !visited[ni]){
              visited[ni]=1;
              stack.push(ni);
            }
          }
        }
      }

      const bw=maxx-minx+1, bh=maxy-miny+1;
      const aspect=bw/bh;
      const fill=area/(bw*bh);

      if(area<120) continue;
      if(aspect<0.7||aspect>1.4) continue;
      if(fill<0.45) continue;

      count++;
    }
  }
  return count;
}

async function run(){
  const file=document.getElementById("photo").files[0];
  if(!file){ out.textContent="Bitte Foto auswÃ¤hlen."; return; }

  const img=new Image();
  img.src=URL.createObjectURL(file);
  await img.decode();

  const scale=Math.min(1, 900/img.width);
  const w=Math.round(img.width*scale);
  const h=Math.round(img.height*scale);

  canvas.width=w; canvas.height=h;
  ctx.drawImage(img,0,0,w,h);
  canvas.style.display="block";

  const data=ctx.getImageData(0,0,w,h).data;
  const red=new Uint8Array(w*h);
  const green=new Uint8Array(w*h);

  for(let p=0,i=0;p<data.length;p+=4,i++){
    const r=data[p], g=data[p+1], b=data[p+2];
    const [H,S,V]=rgbToHsv(r,g,b);

    if(H>=35 && H<=160 && S>=40 && V>=40) green[i]=1;

    const redHSV=((H<=25||H>=335)&&S>=25&&V>=25);
    const redRGB=(r>100&&r>g+30&&r>b+30);
    if(redHSV||redRGB) red[i]=1;
  }

  const redCount=countSquares(red,w,h);
  const greenCount=countSquares(green,w,h);

  out.textContent=
    `Resultat:
ðŸ”´ Rot: ${redCount}
ðŸŸ¢ GrÃ¼n: ${greenCount}`;
}
</script>

</body>
</html>
